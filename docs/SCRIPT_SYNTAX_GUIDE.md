# 腳本撰寫語法與型別指南

為了確保 AI 產生的腳本能一次執行成功，請遵循以下準則：

## 1. 驗證工具匯出項目
*   **動作**：在 `import` 任何工具（如 `db.ts`）之前，務必先使用 `read_file` 查看其原始碼。
*   **常見錯誤**：假設存在 `import { db }`，但實際上工具可能僅匯出 `withDB` 函式。

## 2. 嚴謹處理字串模板與引號
*   **問題**：在 `write_file` 工具呼叫中，巢狀使用反引號 (`` ` ``) 或轉義字元容易導致丟失或解析錯誤。
*   **準則**：
    *   **優先使用字串連接**：對於需要動態產生 Markdown 或複雜輸出的部分，優先使用 `' + var + '` 而非模板字串。
    *   **避免複雜轉義**：若必須使用引號，優先考慮使用雙引號包裹單引號，反之亦然，減少 `\` 的使用。

## 3. TypeScript 型別安全性
*   **型別推斷**：在 Array 方法（如 `map`, `forEach`）中，若 TypeScript 無法推斷型別，請明確標註為 `(doc: any)` 以避免 `TS7006` 錯誤。
*   **MongoDB ID**：從資料庫讀取的 `_id` 在比對時，務必使用 `.toString()` 轉換為字串。

## 4. 效能優化 (Batching)
*   **批次查詢**：禁止在迴圈中執行資料庫查詢。
*   **做法**：先收集所有需要的 ID，使用 `{ $in: ids }` 進行一次性批次查詢，並在記憶體中建立 `Map` 進行比對。
